<?php

/**
 * @file
 * Main module file for MedRemind.
 * Contains all Drupal hooks — these MUST be in .module file.
 * Keeps hooks slim by calling helpers from .inc files.
 */

// ============================================
// CONSTANTS
// Define once, use everywhere
// ============================================

define('MEDREMIND_STATUS_ACTIVE', 1);
define('MEDREMIND_STATUS_PAUSED', 0);
define('MEDREMIND_ACTION_TAKEN', 'taken');
define('MEDREMIND_ACTION_MISSED', 'missed');
define('MEDREMIND_ACTION_SKIPPED', 'skipped');
define('MEDREMIND_DEFAULT_REMINDER', 15);


// ============================================
// HOOK_MENU — Define all URL routes
// ============================================

/**
 * Implements hook_menu().
 */
function medremind_menu() {
  $items = array();

  // Merge all route groups
  $items += _medremind_user_routes();
  $items += _medremind_ajax_routes();
  $items += _medremind_admin_routes();

  return $items;
}

/**
 * User-facing routes.
 */
function _medremind_user_routes() {
  $items = array();

  // Dashboard — /medremind
  $items['medremind'] = array(
    'title' => 'My Medications',
    'page callback' => 'medremind_dashboard_page',
    'access arguments' => array('use medremind'),
    'file' => 'includes/medremind.pages.inc',
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'navigation',
  );

  // Dashboard tab (default)
  $items['medremind/dashboard'] = array(
    'title' => 'Dashboard',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  );

  // Add Medication tab — /medremind/add
  $items['medremind/add'] = array(
    'title' => 'Add Medication',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('medremind_medication_form'),
    'access arguments' => array('use medremind'),
    'file' => 'includes/medremind.forms.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );

  // History tab — /medremind/history
  $items['medremind/history'] = array(
    'title' => 'History',
    'page callback' => 'medremind_history_page',
    'access arguments' => array('use medremind'),
    'file' => 'includes/medremind.pages.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );

  // Settings tab — /medremind/settings
  $items['medremind/settings'] = array(
    'title' => 'My Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('medremind_user_settings_form'),
    'access arguments' => array('use medremind'),
    'file' => 'includes/medremind.forms.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 3,
  );

  // Edit Medication — /medremind/edit/%
  $items['medremind/edit/%'] = array(
    'title' => 'Edit Medication',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('medremind_medication_form', 2),
    'access callback' => 'medremind_medication_access',
    'access arguments' => array(2),
    'file' => 'includes/medremind.forms.inc',
    'type' => MENU_CALLBACK,
  );

  // Delete Medication — /medremind/delete/%
  $items['medremind/delete/%'] = array(
    'title' => 'Delete Medication',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('medremind_delete_confirm_form', 2),
    'access callback' => 'medremind_medication_access',
    'access arguments' => array(2),
    'file' => 'includes/medremind.forms.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * AJAX routes for Take/Skip actions.
 */
function _medremind_ajax_routes() {
  $items = array();

  $items['medremind/take/%/ajax'] = array(
    'title' => 'Take Dose',
    'page callback' => 'medremind_take_dose_ajax',
    'page arguments' => array(2),
    'access callback' => 'medremind_medication_access',
    'access arguments' => array(2),
    'file' => 'includes/medremind.ajax.inc',
    'type' => MENU_CALLBACK,
  );

  $items['medremind/skip/%/ajax'] = array(
    'title' => 'Skip Dose',
    'page callback' => 'medremind_skip_dose_ajax',
    'page arguments' => array(2),
    'access callback' => 'medremind_medication_access',
    'access arguments' => array(2),
    'file' => 'includes/medremind.ajax.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Admin routes.
 */
function _medremind_admin_routes() {
  $items = array();

  $items['admin/config/medremind'] = array(
    'title' => 'MedRemind Settings',
    'description' => 'Configure MedRemind medication reminder settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('medremind_admin_settings_form'),
    'access arguments' => array('administer medremind'),
    'file' => 'includes/medremind.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}


// ============================================
// HOOK_PERMISSION — Define access permissions
// ============================================

/**
 * Implements hook_permission().
 */
function medremind_permission() {
  return array(
    'administer medremind' => array(
      'title' => t('Administer MedRemind'),
      'description' => t('Access MedRemind admin settings.'),
    ),
    'use medremind' => array(
      'title' => t('Use MedRemind'),
      'description' => t('Access MedRemind to manage medications.'),
    ),
  );
}


// ============================================
// HOOK_THEME — Register templates
// ============================================

/**
 * Implements hook_theme().
 */
function medremind_theme() {
  $path = drupal_get_path('module', 'medremind') . '/templates';

  return array(
    'medremind_dashboard' => array(
      'template' => 'medremind-dashboard',
      'path' => $path,
      'variables' => array(
        'medications' => array(),
        'stats' => array(),
        'user_name' => '',
      ),
    ),
    'medremind_med_card' => array(
      'template' => 'medremind-med-card',
      'path' => $path,
      'variables' => array(
        'medication' => NULL,
        'next_dose' => '',
        'streak' => 0,
      ),
    ),
    'medremind_history' => array(
      'template' => 'medremind-history',
      'path' => $path,
      'variables' => array(
        'logs' => array(),
        'month' => '',
        'adherence' => 0,
      ),
    ),
  );
}


// ============================================
// HOOK_HELP — Module help page
// ============================================

/**
 * Implements hook_help().
 */
function medremind_help($path, $arg) {
  switch ($path) {
    case 'admin/help#medremind':
      return '<p>' . t('MedRemind is a medication reminder SaaS application. Users can add medications, set dose schedules, track adherence, and receive reminders.') . '</p>';
  }
}


// ============================================
// HOOK_CRON — Background tasks
// ============================================

/**
 * Implements hook_cron().
 */
function medremind_cron() {
  module_load_include('inc', 'medremind', 'includes/medremind.cron');
  _medremind_process_reminders();
}


// ============================================
// HOOK_BLOCK — Sidebar widgets
// ============================================

/**
 * Implements hook_block_info().
 */
function medremind_block_info() {
  return array(
    'next_dose' => array(
      'info' => t('MedRemind: Next Dose'),
      'cache' => DRUPAL_NO_CACHE,
    ),
    'quick_stats' => array(
      'info' => t('MedRemind: Quick Stats'),
      'cache' => DRUPAL_NO_CACHE,
    ),
  );
}

/**
 * Implements hook_block_view().
 */
function medremind_block_view($delta = '') {
  module_load_include('inc', 'medremind', 'includes/medremind.blocks');

  switch ($delta) {
    case 'next_dose':
      return _medremind_block_next_dose();

    case 'quick_stats':
      return _medremind_block_quick_stats();
  }
}


// ============================================
// ACCESS CALLBACK — Medication ownership check
// ============================================

/**
 * Check if current user owns the medication.
 */
function medremind_medication_access($med_id) {
  global $user;

  if (!user_access('use medremind')) {
    return FALSE;
  }

  if (user_access('administer medremind')) {
    return TRUE;
  }

  if (!db_table_exists('medremind_medications')) {
    return FALSE;
  }

  $owner = db_query(
    'SELECT uid FROM {medremind_medications} WHERE med_id = :mid',
    array(':mid' => $med_id)
  )->fetchField();

  return ($owner == $user->uid);
}
